<?php
// Migración exacta del contenido visual del archivo original
$this->headTitle('Mapas de Percentiles - Región de Valparaíso');

// Scripts JS necesarios para esta página
$this->inlineScript()
    ->appendFile($this->basePath('/js/leaflet/leaflet.js'))
    ->appendFile($this->basePath('/js/highcharts/highcharts.js'))
    ->appendFile($this->basePath('/js/highcharts/map.js'))
    ->appendFile($this->basePath('/js/highcharts/pattern-fill.js'))
    ->appendFile('https://code.highcharts.com/modules/exporting.js')
    ->appendFile('https://code.highcharts.com/modules/export-data.js')
    ->appendFile('https://code.highcharts.com/modules/offline-exporting.js')
    ->appendFile($this->basePath('/js/turf/turf.min.js'))
    ->appendFile($this->basePath('/js/easyprint/bundle.min.js'))
    ->appendFile($this->basePath('/js/utils-geo.js'))
    ->appendFile($this->basePath('/js/mapasPercintil.js'));
?>
<div class="container-fluid main-container">
    <h1>Monitor de Sequías - Mapas de Percentiles (Región de Valparaíso)</h1>
    <hr>
    <div class="row">
        <div class="col-md-2">
            <?= $this->partial('application/partial/sidebar.phtml', ['activeRoute' => 'percentiles']) ?>
        </div>

        <div class="col-md-10">
            <div id="seccion-mapas-percentiles" class="content-section active m-0">
                <div class="card">
                    <div class="card-header bg-cabezera text-white">
                        <h5 id="titulo-tarjeta">Mapas de Percentiles - Región de Valparaíso</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Mapa de Percentil de Precipitación</h6>
                                <div id="map-percentil-precip" class="map-container">
                                    <div class="map-loading-placeholder">Cargando mapa de precipitación...</div>
                                </div>
                                <div class="export-button-container text-center">
                                    <button class="btn btn-sm btn-primary export-pdf-btn" data-map-id="map-percentil-precip">
                                        <span> Ver Explicación </span> <i class="fa fa-external-link"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Mapa de Percentil de Temperatura Media</h6>
                                <div id="map-percentil-temp" class="map-container">
                                    <div class="map-loading-placeholder">Cargando mapa de temperatura...</div>
                                </div>
                                <div class="export-button-container text-center">
                                    <button class="btn btn-sm btn-primary export-pdf-btn" data-map-id="map-percentil-temp">
                                        <span> Ver Explicación </span> <i class="fa fa-external-link"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
        document.addEventListener('DOMContentLoaded', function() {
        // Obtener la fecha real de los datos de percentiles
        async function actualizarTitulosConFechaReal() {
            try {
                const response = await fetch('/api/datos_percentiles');
                const datosPercentiles = await response.json();
                
                // Obtener la fecha del primer dato disponible
                const primerDatoTemp = Object.values(datosPercentiles.temperatura)[0];
                if (primerDatoTemp && primerDatoTemp.ultimo_mes) {
                    const [ano, mes] = primerDatoTemp.ultimo_mes.split('-');
                    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    const nombreMes = meses[parseInt(mes) - 1];
                    
                    // Actualizar el título de la tarjeta
                    const tituloTarjeta = document.getElementById('titulo-tarjeta');
                    tituloTarjeta.textContent = `Mapas de Percentiles - Región de Valparaíso - ${nombreMes}`;
                }
            } catch (error) {
                // Fallback a fecha actual si hay error
                const fechaActual = new Date();
                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const mesActual = meses[fechaActual.getMonth()];
                const anoActual = fechaActual.getFullYear();
                
                const tituloTarjeta = document.getElementById('titulo-tarjeta');
                tituloTarjeta.textContent = `Mapas de Percentiles - Región de Valparaíso ${mesActual} ${anoActual}`;
            }
        }
        
        // Ejecutar la función para actualizar títulos
        actualizarTitulosConFechaReal();
 
        // Funcionalidad para descargar mapas
        document.querySelectorAll('.download-map-btn').forEach(button => {
            button.addEventListener('click', function() {
                const mapId = this.getAttribute('data-map-id');
                
                // Obtener la instancia del gráfico de Highcharts
                const chart = Highcharts.charts.find(chart => 
                    chart && chart.renderTo && chart.renderTo.id === mapId
                );
                
                if (chart) {
                    // Configurar opciones de exportación
                    const exportOptions = {
                        type: 'image/png',
                        filename: mapId === 'map-percentil-precip' ? 
                            'mapa_percentil_precipitacion' : 'mapa_percentil_temperatura',
                        width: 1200,
                        scale: 2
                    };
                    
                    // Exportar el mapa
                    chart.exportChart(exportOptions);
                } else {
                }
            });
        });

        document.querySelectorAll('.export-pdf-btn').forEach(button => {
            button.addEventListener('click', function() {
                const mapId = this.getAttribute('data-map-id');

                const pdfMapping = {
                    'map-percentil-precip': 'Ficha_percentil_precipitacion.pdf',
                    'map-percentil-temp': 'Ficha_percentil_temperatura.pdf',
                };
                const pdfFileName = pdfMapping[mapId];

                if (pdfFileName) {
                    const pdfPath = `/pdf/${pdfFileName}`;
                    
                    // Abrir el PDF en una nueva ventana/pestaña
                    window.open(pdfPath, '_blank');
                } else {
                    alert('No se encontró el archivo PDF explicativo para este mapa.');
                }
            });
        });
    });
</script>
