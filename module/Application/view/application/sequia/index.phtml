<?php // module/Application/view/application/sequia/index.phtml 
?>

<?php
// Le decimos a la vista cuál es el título de esta página
$this->headTitle('Monitor de Sequías');
// En public/index.php
error_reporting(E_ALL);
ini_set('display_errors', 1);
// Añadimos los scripts JS específicos para esta página
$this->inlineScript()
    ->appendFile($this->basePath('/js/highcharts/highcharts.js'))
    ->appendFile($this->basePath('/js/highcharts/map.js'))
    ->appendFile($this->basePath('/js/highcharts/pattern-fill.js'))
    ->appendFile($this->basePath('/js/turf/turf.min.js'))
    ->appendFile($this->basePath('/js/easyprint/bundle.min.js'))
    // sequia.js se carga desde el sistema secuencial
    // ->appendFile($this->basePath('/js/sequia.js?v=' . time()));
?>

<div class="container-fluid main-container">
    <hr>
    <div id="contenedor-tabla"></div>
    <div id="contenedor-imagenes" class="row"></div>
    <div class="row">
        <div class="col-md-2">
            <?= $this->partial('application/partial/sidebar.phtml', ['activeRoute' => 'indice-combinado']) ?>
        </div>

        <div class="col-md-10"style="padding-left: 0px;padding-right: 0px;">
            <div class="card">
                <div class="card-header bg-cabezera text-white">
                    <strong id="titulo-afectacion-categoria">Porcentaje de afectación y categoría</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="card col-md-3" style="padding-left: 0px;padding-right: 0px;">
                            <div class="card-header bg-cabezera text-white">
                                <h6>Promedio Regional</h6>
                            </div>
                            <table class="table table-sm table-bordered" id="regional-avg-table">
                                <thead>
                                    <tr>
                                        <th>Cat.</th>
                                        <th>Descripción</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="background-color:#d9d9d9;">SA</td>
                                        <td>Sin Sequía</td>
                                        <td id="avg-sa">-</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color:#ffff00;">D0</td>
                                        <td>Anormalmente Seco</td>
                                        <td id="avg-d0">10%</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color:#fcd37f;">D1</td>
                                        <td>Sequía Moderada</td>
                                        <td id="avg-d1">5%</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color:#ffaa00;">D2</td>
                                        <td>Sequía Severa</td>
                                        <td id="avg-d2">0%</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color:#EA2B00;">D3</td>
                                        <td>Sequía Extrema</td>
                                        <td id="avg-d3">0%</td>
                                    </tr>
                                    <tr>
                                        <td style="background-color:#801300;">D4</td>
                                        <td>Sequía Excepcional</td>
                                        <td id="avg-d4">0%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                     
                        <div class="card col-md-9">
                            <div class="row">
                            <div class="col-md-8" style="padding-left: 0px;padding-right: 0px;">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center bg-cabezera text-white">
                                        <h6>Categorías por Comuna (% Área D0-D4)</h6>
                                        <div id="map-legend" class="legend d-inline-block">
                                        <table class="table-legend">
                                            <tr>
                                                <td><span class="color-box" style="background:#d9d9d9;"></span> SS</td>
                                                <td><span class="color-box" style="background:#ffff00;"></span> D0</td>
                                                <td><span class="color-box" style="background:#fcd37f;"></span> D1</td>
                                            </tr>
                                            <tr>
                                                <td><span class="color-box" style="background:#ffaa00;"></span> D2</td>
                                                <td><span class="color-box" style="background:#EA2B00;"></span> D3</td>
                                                <td><span class="color-box" style="background:#801300;"></span> D4</td>
                                            </tr>
                                        </table>
                                    </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="mapaValparaisoLeaflet" style="height: 600px;">
                                            <div class="d-flex justify-content-center align-items-center h-100">
                                                <div class="text-center">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Cargando...</span>
                                                    </div>
                                                    <div class="mt-2">
                                                        <small class="text-muted">Cargando mapa de sequía...</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4" style="padding-left: 0px;padding-right: 0px;" >
                                <div id="panel-detalle-comuna" class="card" style="display: none;">
                                    <div class="card-header bg-cabezera text-white d-flex justify-content-between align-items-center">
                                        <strong id="detalle-comuna-nombre">Detalle de Comuna</strong>
                                        <button type="button" class="btn-close btn-close-white" id="cerrar-panel-detalle" aria-label="Close"></button>
                                    </div>
                                    <div class="card-body">
                                        <div id="detalle-comuna-contenido"></div>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card con mapa que se muestra por debajo de Promedio Regional y Categorías por Comuna -->
            <div class="card mt-3">
                <div class="card-header bg-cabezera text-white">Serie de Tiempo Porcentaje de afectación</div>
                <div class="card-body">
                    <div id="timeSeriesChartRegionalSidebar" style="width:100%; height:350px;">
                        <div class="d-flex justify-content-center align-items-center h-100">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Cargando gráfico temporal...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                        <div class="card-header bg-cabezera text-white">
                            <strong>Persistencia de la Sequía con SPI</strong>
                        </div>
                        <div class="card-body" id="persistencia-container">
                            <div class="persistencia-map-grid">
                                <div class="persistencia-map-item">
                                    <p>3 meses</p>
                                    <div id="mapaPersistencia3m" class="small-leaflet-map">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                <div class="persistencia-map-item">
                                    <p>9 meses</p>
                                    <div id="mapaPersistencia9m" class="small-leaflet-map">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="persistencia-map-item">
                                    <p>12 meses</p>
                                    <div id="mapaPersistencia12m" class="small-leaflet-map">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="persistencia-map-item">
                                    <p>24 meses</p>
                                    <div id="mapaPersistencia24m" class="small-leaflet-map">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="persistencia-map-item">
                                    <p>48 meses</p>
                                    <div id="mapaPersistencia48m" class="small-leaflet-map">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal del Mapa -->
<div id="mapModal" class="map-modal"> <div class="map-modal-content">
        <span class="map-modal-close-button">&times;</span> <h3 id="modalMapTitle"></h3> <div id="modalMapContainer"></div> </div>
    </div>

<script>
    // Función para cargar scripts secuencialmente
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Verificar que Leaflet esté disponible
            if (typeof L === 'undefined') {
                console.error('Leaflet no está disponible');
                return;
            }
            
            // Verificar que las clases estén disponibles (ya cargadas desde el layout)
            if (!window.Model || !window.View || !window.Controller) {
                console.error('Las clases MVC no están disponibles:', {
                    Model: !!window.Model,
                    View: !!window.View,
                    Controller: !!window.Controller
                });
                return;
            }
            
            console.log('Iniciando sistema MVC para sequía...');
            const model = new window.Model();
            const view = new window.View();
            const controller = new window.Controller(model, view);
            
            controller.init();
            
        } catch (error) {
            console.error('Error inicializando sistema MVC:', error);
        }
    });
</script>